---
title: "Nessus to POAM Converter Documentation and Code Explanation"
date: "2025-02-06"
---

## Overview

This repository contains a PowerShell script that converts Nessus vulnerability scan results (`.nessus` files) into a Plan of Actions and Milestones (POAM) formatted Excel spreadsheet. The script automates the conversion process, making it easier to track vulnerabilities and manage remediation actions.

This README provides a detailed, block-by-block explanation of the code, usage instructions, and additional project information.

## Repository Structure

Nessus-to-POAM-Documentation/ ├── LICENSE ├── README.md ├── .gitignore ├── NessusToPOAM.ps1 └── NessusToPOAM_Explanation.tex


- **NessusToPOAM.ps1**: The main PowerShell script.
- **NessusToPOAM_Explanation.tex**: A LaTeX document with a detailed explanation of the script.
- **README.md**: This file, containing an overview and a detailed code explanation.
- **LICENSE**: The project's license file.
- **.gitignore**: A file specifying files and directories to ignore in version control.

## Detailed Code Explanation

Below is a detailed, block-by-block explanation of the PowerShell script.

### 1. Header Comments

```powershell
# =============================================================================
# Nessus to POAM Converter
# Author: Shane Trimbur
# Last Updated: January 15, 2025
# =============================================================================

Explanation:
This section provides metadata about the script: its title, author, and last update date. It serves as documentation and reference for anyone reviewing the code.
2. Description and Usage Information

#
# DESCRIPTION:
# This PowerShell script converts Nessus vulnerability scan results (.nessus files) 
# into a Plan of Actions and Milestones (POAM) Excel spreadsheet format.
#
# PREREQUISITES:
# - PowerShell 5.1 or higher
# - Administrator rights (for module installation if ImportExcel is not present)
# - A valid .nessus scan file
#
# USAGE:
# 1. Basic usage with default output filename:
#    .\NessusToPOAM.ps1 -NessusFile "path\to\scan.nessus"
#
# 2. Specify custom output filename:
#    .\NessusToPOAM.ps1 -NessusFile "path\to\scan.nessus" -OutputFile "custom_poam.xlsx"
#
# OUTPUT:
# - Creates an Excel file with formatted POAM data
# - Default filename format: POAM_YYYYMMDD.xlsx
# - Includes risk levels, vulnerability details, and system information
#

Explanation:
This block provides a high-level overview of the script's functionality, lists prerequisites, and explains how to use the script with examples. It also describes the output generated by the script.
3. Parameter Definition

param(
    [Parameter(Mandatory = $true)]
    [string]$NessusFile,
    
    [Parameter(Mandatory = $false)]
    [string]$OutputFile = "POAM_$(Get-Date -Format 'yyyyMMdd').xlsx"
)

Explanation:
This section defines the input parameters:

    $NessusFile: A mandatory parameter specifying the path to the Nessus scan file.
    $OutputFile: An optional parameter for the output Excel file name. If not provided, it defaults to a filename that includes the current date.

4. Module Check and Installation

if (-not (Get-Module -ListAvailable -Name ImportExcel)) {
    Write-Host "Installing ImportExcel module..."
    Install-Module ImportExcel -Force -Scope CurrentUser
}

Import-Module ImportExcel

Explanation:
This block checks whether the ImportExcel module is installed. If it isn't, the script installs it to ensure that Excel operations can be performed. After ensuring the module is available, it is imported for use in the script.
5. Function: ConvertTo-RiskLevel

function ConvertTo-RiskLevel {
    param([string]$Severity)
    
    switch ($Severity) {
        "1" { return "Low" }
        "2" { return "Moderate" }
        "3" { return "High" }
        "4" { return "Critical" }
        default { return "Unknown" }
    }
}

Explanation:
This function maps numerical severity values from the Nessus scan to descriptive risk levels:

    1 becomes "Low"
    2 becomes "Moderate"
    3 becomes "High"
    4 becomes "Critical"
    Any other value returns "Unknown"

6. Function: Get-HostIP

function Get-HostIP {
    param($ReportHost)
    
    $ipNode = $ReportHost.SelectSingleNode(".//tag[@name='host-ip']")
    if ($ipNode -ne $null) {
        return $ipNode.InnerText
    }
    return "Unknown IP"
}

Explanation:
This function extracts the IP address from a given XML node representing a host:

    It searches for a tag with the attribute name="host-ip".
    If the tag is found, it returns the inner text (the IP address); otherwise, it returns "Unknown IP".

7. Function: Process-NessusFile

function Process-NessusFile {
    param([string]$FilePath)
    
    try {
        Write-Host "Reading Nessus file..."
        [xml]$nessusContent = Get-Content -Path $FilePath -Encoding UTF8
        $findings = @()
        $poamId = 1
        
        Write-Host "Processing vulnerability data..."
        foreach ($reportHost in $nessusContent.SelectNodes("//ReportHost")) {
            $hostname = $reportHost.name
            if ([string]::IsNullOrEmpty($hostname)) {
                $hostname = "Unknown Host"
            }
            
            $ip = Get-HostIP -ReportHost $reportHost
            
            foreach ($item in $reportHost.SelectNodes(".//ReportItem")) {
                if ($item.severity -eq "0") { continue }
                
                $description = if ($item.description -ne $null) { $item.description } else { "" }
                $solution = if ($item.solution -ne $null) { $item.solution } else { "" }
                
                $finding = [PSCustomObject]@{
                    'POAM ID'                      = $poamId
                    'Name'                         = $item.pluginName
                    'Date Identified'              = Get-Date -Format "yyyy-MM-dd"
                    'Source Identifying Weakness'  = "Nessus Scan - Plugin ID: $($item.pluginID)"
                    'POAM Status'                  = "Open"
                    'Calculated Risk Level'        = ConvertTo-RiskLevel -Severity $item.severity
                    'Mitigated Risk Level'         = ""
                    'Estimated Completion Date'    = ""
                    'Actual Start Date'            = Get-Date -Format "yyyy-MM-dd"
                    'Actual Completion Date'       = ""
                    'Vulnerability Library'        = ""
                    'Allocated Control'            = ""
                    'Subjective Mitigated Risk Level' = ""
                    'Weaknesses'                   = $description
                    'Mitigation'                   = $solution
                    'Comments'                     = ""
                    'Affected Hardware'            = "$hostname ($ip)"
                    'Days Open'                    = "0"
                    'Last Updated'                 = Get-Date -Format "yyyy-MM-dd"
                }
                
                $findings += $finding
                $poamId++
            }
        }
        
        Write-Host "Found $($findings.Count) vulnerabilities..."
        return $findings
    }
    catch {
        Write-Error "Failed to process Nessus file. Error: $_"
        exit 1
    }
}

Explanation:
This function is the core of the script, processing the Nessus XML file:

    Reading and Parsing:
    The file is read as XML and stored in $nessusContent.
    Initialization:
    An empty array $findings is created to store vulnerabilities, and $poamId is initialized to assign a unique ID to each finding.
    Iterating Over Hosts:
    The function loops through each <ReportHost> node, retrieving the hostname (defaulting to "Unknown Host" if not provided) and IP address.
    Iterating Over Vulnerabilities:
    For each <ReportItem> (vulnerability) node:
        It skips items with a severity of "0".
        Extracts the description and solution, ensuring they are not null.
        Constructs a custom object containing all relevant details.
        Increments the POAM ID.
    Error Handling:
    Any errors during processing are caught, an error message is displayed, and the script exits.

8. Main Execution Block

try {
    Write-Host "Starting Nessus to POAM conversion..."
    
    if (Test-Path $OutputFile) {
        Write-Warning "Output file already exists. It will be overwritten."
        Remove-Item $OutputFile -Force
    }
    
    $findings = Process-NessusFile -FilePath $NessusFile
    if (-not $findings) {
        throw "No findings were processed from the Nessus file"
    }
    
    Write-Host "Exporting to Excel..."
    $excelParams = @{
        Path = $OutputFile
        AutoSize = $true
        AutoFilter = $true
        BoldTopRow = $true
        WorksheetName = "POAM"
        TableStyle = "Medium2"
        FreezeTopRow = $true
    }
    
    $findings | Export-Excel @excelParams
    
    $excel = Open-ExcelPackage -Path $OutputFile
    $ws = $excel.Workbook.Worksheets["POAM"]
    
    $headerRange = $ws.Dimension.Address -replace "\d+", "1"
    $ws.Row(1).Style.Fill.PatternType = 'Solid'
    $ws.Row(1).Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::FromArgb(54, 96, 146))
    $ws.Row(1).Style.Font.Color.SetColor([System.Drawing.Color]::White)
    
    foreach ($col in 1..$ws.Dimension.Columns) {
        $ws.Column($col).AutoFit()
    }
    
    Close-ExcelPackage $excel
    
    $fullOutputPath = Join-Path (Resolve-Path .).Path $OutputFile
    Write-Host "POAM spreadsheet created successfully: $fullOutputPath" -ForegroundColor Green
}
catch {
    Write-Error "An error occurred: $_"
    exit 1
}

Explanation:
This block serves as the entry point for the script:

    Initialization and Cleanup:
    It starts by announcing the conversion process and checks if the output file exists; if so, it removes the existing file to avoid conflicts.
    Processing:
    The script calls Process-NessusFile to extract vulnerability findings.
    Exporting to Excel:
    Findings are exported to an Excel file with specified formatting parameters (e.g., auto-sizing columns, applying filters, and styling the header row).
    Additional Excel Formatting:
    The script opens the generated Excel package to apply additional formatting such as setting header background and font colors, then auto-fits all columns.
    Completion Message:
    A success message is displayed with the full output path of the created spreadsheet.
    Error Handling:
    Any errors encountered cause the script to output an error message and exit.

Usage Instructions

To run the script, open PowerShell and execute one of the following commands:

    Basic Usage:

.\NessusToPOAM.ps1 -NessusFile "path\to\scan.nessus"

Custom Output File:

    .\NessusToPOAM.ps1 -NessusFile "path\to\scan.nessus" -OutputFile "custom_poam.xlsx"

Note: Ensure that you have PowerShell 5.1 or higher and administrator rights (if necessary) for module installations.
Contributing

Contributions are welcome! Please fork the repository, make your changes, and submit a pull request. Whether it's improving the code or enhancing the documentation, your contributions are appreciated.
License

This project is licensed under the MIT License. See the LICENSE file for details.